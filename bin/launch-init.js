#!/usr/bin/env node

import fs from 'fs';
import path from 'path';

const functionsDir = path.join(process.cwd(), 'functions');
const edgeFile = path.join(functionsDir, '[proxy].edge.js');

// Simple ANSI colors for better terminal output
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  cyan: '\x1b[36m',
  blue: '\x1b[34m'
};

const template = `
import {
  jsonResponse,
  passThrough,
  redirectIfMatch,
  protectWithBasicAuth,
  ipAccessControl,
  blockAICrawlers,
  getGeoHeaders,
  handleNextJS_RSC
} from "@aryanbansal-launch/edge-utils";

/**
 * Default Edge Handler for Contentstack Launch
 * This file was automatically generated by @aryanbansal-launch/edge-utils
 */
export default async function handler(request, context) {
  // 1. ‚öõÔ∏è Fix Next.js RSC issues for specific paths
  const rscResponse = await handleNextJS_RSC(request, {
    affectedPaths: ["/my-rsc-page", "/another-page"]
  });
  if (rscResponse) return rscResponse;

  // 2. üõ°Ô∏è Block AI bots immediately
  const botResponse = blockAICrawlers(request);
  if (botResponse) return botResponse;

  // 3. üß± IP Whitelisting
  const ipResponse = ipAccessControl(request, { allow: ["203.0.113.10"] });
  if (ipResponse) return ipResponse;

  // 4. üîê Domain-specific Basic Auth
  const authResponse = await protectWithBasicAuth(request, {
    hostnameIncludes: "staging.myapp.com",
    username: "admin",
    password: "securepassword123"
  });
  if (authResponse && authResponse.status === 401) return authResponse;

  // 5. üîÄ SEO-friendly Redirects
  const redirectResponse = redirectIfMatch(request, {
    path: "/legacy-url",
    to: "/modern-url",
    status: 301
  });
  if (redirectResponse) return redirectResponse;

  // 6. üìç Geo-Location Access
  const geo = getGeoHeaders(request);
  if (geo.country === "US") {
    console.log(\`User from \${geo.city}, \${geo.region}\`);
  }

  // 7. üì§ Custom JSON Responses
  if (new URL(request.url).pathname === "/api/health") {
    return jsonResponse({ status: "healthy", region: geo.region });
  }

  // 8. üöÄ Pass through to origin
  return passThrough(request);
}
`.trim();

async function init() {
  console.log(`\n${colors.bright}${colors.cyan}üöÄ Edge Utilities: Contentstack Launch Setup${colors.reset}\n`);

  let actionsTaken = 0;
  let isRoot = true;

  // 1. Root level check: Look for package.json
  const packageJsonPath = path.join(process.cwd(), 'package.json');
  if (!fs.existsSync(packageJsonPath)) {
    isRoot = false;
    console.log(`${colors.yellow}‚ö†Ô∏è  Warning: Root directory not detected.${colors.reset}`);
    console.log(`${colors.yellow}   We couldn't find a package.json. If this isn't your project root,${colors.reset}`);
    console.log(`${colors.yellow}   the 'functions' folder might be created in the wrong place.\n${colors.reset}`);
  }

  try {
    // 2. Folder existence check
    if (!fs.existsSync(functionsDir)) {
      fs.mkdirSync(functionsDir, { recursive: true });
      console.log(`${colors.green}‚ú® New:${colors.reset} Created /functions directory`);
      actionsTaken++;
    } else {
      console.log(`${colors.blue}‚ÑπÔ∏è  Existing:${colors.reset} /functions directory already found`);
    }

    // 3. File existence check (don't overwrite user's work)
    if (!fs.existsSync(edgeFile)) {
      fs.writeFileSync(edgeFile, template + '\n');
      console.log(`${colors.green}‚ú® New:${colors.reset} Created /functions/[proxy].edge.js`);
      actionsTaken++;
    } else {
      console.log(`${colors.blue}‚ÑπÔ∏è  Existing:${colors.reset} /functions/[proxy].edge.js already found`);
    }

    // Final Summary Messages based on the state
    if (!isRoot) {
      console.log(`\n${colors.yellow}‚ö†Ô∏è  Setup detected in a subdirectory!${colors.reset}`);
      console.log(`The 'functions' folder exists here, but Contentstack Launch`);
      console.log(`requires it to be at the ${colors.bright}project root${colors.reset} (next to package.json).`);
    } else if (actionsTaken === 0) {
      console.log(`\n${colors.bright}${colors.blue}üèÅ Everything is already set up!${colors.reset}`);
      console.log(`No changes were made to your existing files.`);
    } else {
      console.log(`\n${colors.bright}${colors.green}üéâ Setup Complete!${colors.reset}`);
      console.log(`Successfully prepared your edge environment.`);
    }

    console.log(`\n${colors.bright}Next Steps:${colors.reset}`);
    console.log(`1. Open ${colors.cyan}functions/[proxy].edge.js${colors.reset}`);
    console.log(`2. Customize your redirects, auth, and RSC paths`);
    console.log(`3. Deploy your project to Contentstack Launch\n`);
    
    console.log(`${colors.blue}Documentation:${colors.reset} https://github.com/AryanBansal-launch/launch-edge-utils#readme\n`);
  } catch (error) {
    console.error(`\n${colors.red}‚ùå Error during setup:${colors.reset}`, error.message);
    process.exit(1);
  }
}

init();
